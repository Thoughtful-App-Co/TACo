name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # ============================================================================
  # DEPENDENCY SCANNING
  # Scans for known vulnerabilities in npm dependencies
  # ============================================================================
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # npm audit - built-in Node.js security scanner
      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Run npm audit (JSON output)
        run: npm audit --json > npm-audit-results.json || true

      - name: Upload npm audit results
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-results
          path: npm-audit-results.json
          retention-days: 30

      # Trivy - comprehensive vulnerability scanner
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-dependency-scan'

  # ============================================================================
  # SECRET DETECTION
  # Scans for accidentally committed secrets, API keys, passwords
  # ============================================================================
  secret-detection:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Gitleaks - fast secret scanner
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        continue-on-error: true

      # TruffleHog - comprehensive secret scanner with entropy analysis
      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified
        continue-on-error: true

  # ============================================================================
  # SAST - CODEQL
  # Static Application Security Testing using GitHub's CodeQL
  # ============================================================================
  codeql-analysis:
    name: CodeQL SAST Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: ['javascript-typescript']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: '/language:${{matrix.language}}'

  # ============================================================================
  # SAST - SEMGREP
  # Fast, lightweight static analysis tool with excellent JS/TS support
  # ============================================================================
  semgrep-sast:
    name: Semgrep SAST Scan
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          semgrep scan \
            --config auto \
            --config p/javascript \
            --config p/typescript \
            --config p/react \
            --config p/security-audit \
            --config p/secrets \
            --config p/owasp-top-ten \
            --sarif \
            --output semgrep-results.sarif
        continue-on-error: true

      - name: Upload Semgrep results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep-results.sarif
          category: 'semgrep-sast'

  # ============================================================================
  # SBOM GENERATION & SIGNING
  # Software Bill of Materials generation using Syft and signing with Cosign
  # ============================================================================
  sbom-generation:
    name: SBOM Generation & Signing
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write # Required for Cosign keyless signing
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Syft - SBOM generation tool from Anchore
      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Generate SBOM (SPDX format)
        run: |
          syft . -o spdx-json=sbom-spdx.json
          syft . -o cyclonedx-json=sbom-cyclonedx.json

      # Cosign - for signing SBOMs (keyless mode using OIDC)
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign SBOM with Cosign (keyless)
        if: github.event_name != 'pull_request'
        run: |
          cosign sign-blob --yes \
            --output-signature sbom-spdx.json.sig \
            --output-certificate sbom-spdx.json.cert \
            sbom-spdx.json

          cosign sign-blob --yes \
            --output-signature sbom-cyclonedx.json.sig \
            --output-certificate sbom-cyclonedx.json.cert \
            sbom-cyclonedx.json
        env:
          COSIGN_EXPERIMENTAL: 1

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            sbom-spdx.json
            sbom-spdx.json.sig
            sbom-spdx.json.cert
            sbom-cyclonedx.json
            sbom-cyclonedx.json.sig
            sbom-cyclonedx.json.cert
          retention-days: 90

      # Grype - vulnerability scanner for SBOMs
      - name: Install Grype
        uses: anchore/scan-action/download-grype@v4

      - name: Scan SBOM for vulnerabilities
        run: |
          grype sbom:sbom-spdx.json -o sarif > grype-results.sarif
        continue-on-error: true

      - name: Upload Grype results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: grype-results.sarif
          category: 'grype-sbom-scan'

  # ============================================================================
  # DAST / PENETRATION TESTING
  # Dynamic Application Security Testing using OWASP ZAP
  # ============================================================================
  zap-dast-scan:
    name: OWASP ZAP DAST Scan
    runs-on: ubuntu-latest
    needs: [dependency-scan] # Run after build is validated
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      # Start a simple server to serve the built app
      - name: Start preview server
        run: |
          npx serve dist -l 3000 &
          sleep 5  # Wait for server to start

      # OWASP ZAP Baseline Scan - passive scanning
      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
        continue-on-error: true

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-report
          path: report_html.html
          retention-days: 30

  # ============================================================================
  # LICENSE COMPLIANCE
  # Check for problematic licenses in dependencies
  # ============================================================================
  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install license-checker
        run: npm install -g license-checker

      - name: Check licenses
        run: |
          license-checker --summary --failOn "GPL-3.0;AGPL-3.0;GPL-2.0" || true
          license-checker --json > license-report.json

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: license-report.json
          retention-days: 30

  # ============================================================================
  # OSV-SCANNER
  # Google's Open Source Vulnerability database scanner
  # ============================================================================
  osv-scanner:
    name: OSV Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run OSV-Scanner
        uses: google/osv-scanner-action@v1
        with:
          scan-args: |-
            --lockfile=package-lock.json
            --format=sarif
            --output=osv-results.sarif
        continue-on-error: true

      - name: Upload OSV results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: osv-results.sarif
          category: 'osv-scanner'

  # ============================================================================
  # INFRASTRUCTURE AS CODE SCANNING
  # Checkov - scans IaC files (wrangler.toml, etc.)
  # ============================================================================
  iac-security-scan:
    name: Infrastructure as Code Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: all
          output_format: sarif
          output_file_path: checkov-results.sarif
          soft_fail: true

      - name: Upload Checkov results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-results.sarif
          category: 'checkov-iac'

  # ============================================================================
  # SLSA PROVENANCE & ATTESTATION
  # Supply chain security - generates provenance for builds (Gov/FedRAMP requirement)
  # ============================================================================
  slsa-provenance:
    name: SLSA Provenance Generation
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      id-token: write
      attestations: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Create build archive
        run: |
          tar -czvf build-artifact.tar.gz dist/
          sha256sum build-artifact.tar.gz > build-artifact.tar.gz.sha256

      - name: Generate SLSA Provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: build-artifact.tar.gz

      - name: Upload provenance artifacts
        uses: actions/upload-artifact@v4
        with:
          name: slsa-provenance
          path: |
            build-artifact.tar.gz
            build-artifact.tar.gz.sha256
          retention-days: 90

  # ============================================================================
  # SECURITY HEADERS CHECK
  # Validates security headers on deployed site
  # ============================================================================
  security-headers-check:
    name: Security Headers Validation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Start preview server
        run: |
          npx serve dist -l 3000 &
          sleep 5

      # Check security headers using curl
      - name: Check Security Headers
        run: |
          echo "## Security Headers Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          HEADERS=$(curl -sI http://localhost:3000)

          echo "### Response Headers" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$HEADERS" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recommended Headers Checklist" >> $GITHUB_STEP_SUMMARY

          check_header() {
            if echo "$HEADERS" | grep -qi "$1"; then
              echo "- [x] $1" >> $GITHUB_STEP_SUMMARY
            else
              echo "- [ ] $1 (missing)" >> $GITHUB_STEP_SUMMARY
            fi
          }

          check_header "X-Content-Type-Options"
          check_header "X-Frame-Options"
          check_header "X-XSS-Protection"
          check_header "Strict-Transport-Security"
          check_header "Content-Security-Policy"
          check_header "Referrer-Policy"
          check_header "Permissions-Policy"

  # ============================================================================
  # FIPS COMPLIANCE CHECK
  # Validates cryptographic library usage for gov compliance
  # ============================================================================
  fips-compliance-check:
    name: FIPS Compliance Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for non-FIPS crypto usage
        run: |
          echo "## FIPS Compliance Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for potentially non-FIPS compliant crypto patterns
          echo "### Checking for weak/non-FIPS crypto patterns..." >> $GITHUB_STEP_SUMMARY

          ISSUES=0

          # Check for MD5 usage (not FIPS approved)
          if grep -r "md5\|MD5" --include="*.ts" --include="*.tsx" --include="*.js" src/ 2>/dev/null; then
            echo "- [ ] MD5 usage detected (not FIPS approved)" >> $GITHUB_STEP_SUMMARY
            ISSUES=$((ISSUES+1))
          else
            echo "- [x] No MD5 usage detected" >> $GITHUB_STEP_SUMMARY
          fi

          # Check for SHA1 usage (deprecated in FIPS)
          if grep -r "sha1\|SHA1\|sha-1\|SHA-1" --include="*.ts" --include="*.tsx" --include="*.js" src/ 2>/dev/null; then
            echo "- [ ] SHA-1 usage detected (deprecated in FIPS)" >> $GITHUB_STEP_SUMMARY
            ISSUES=$((ISSUES+1))
          else
            echo "- [x] No SHA-1 usage detected" >> $GITHUB_STEP_SUMMARY
          fi

          # Check for weak random number generation
          if grep -r "Math\.random" --include="*.ts" --include="*.tsx" --include="*.js" src/ 2>/dev/null; then
            echo "- [ ] Math.random() usage detected (use crypto.getRandomValues for security)" >> $GITHUB_STEP_SUMMARY
            ISSUES=$((ISSUES+1))
          else
            echo "- [x] No Math.random() for crypto detected" >> $GITHUB_STEP_SUMMARY
          fi

          # Check for DES usage (not FIPS approved)
          if grep -r "DES\|des-" --include="*.ts" --include="*.tsx" --include="*.js" src/ 2>/dev/null; then
            echo "- [ ] DES usage detected (not FIPS approved)" >> $GITHUB_STEP_SUMMARY
            ISSUES=$((ISSUES+1))
          else
            echo "- [x] No DES usage detected" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total potential issues: $ISSUES**" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

  # ============================================================================
  # DEPENDENCY PROVENANCE CHECK
  # Validates that dependencies have verifiable provenance
  # ============================================================================
  dependency-provenance:
    name: Dependency Provenance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Check npm package provenance
        run: |
          echo "## Dependency Provenance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checking if dependencies have npm provenance..." >> $GITHUB_STEP_SUMMARY

          # Install with provenance verification
          npm ci --ignore-scripts

          # List packages with their integrity hashes
          npm ls --json > dependency-tree.json 2>/dev/null || true

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Dependency tree exported to artifact." >> $GITHUB_STEP_SUMMARY

      - name: Upload dependency tree
        uses: actions/upload-artifact@v4
        with:
          name: dependency-provenance
          path: dependency-tree.json
          retention-days: 30

  # ============================================================================
  # SECURITY SUMMARY
  # Aggregate results and report
  # ============================================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs:
      [
        dependency-scan,
        secret-detection,
        codeql-analysis,
        semgrep-sast,
        sbom-generation,
        license-check,
        osv-scanner,
        iac-security-scan,
        fips-compliance-check,
        dependency-provenance,
      ]
    if: always()
    steps:
      - name: Security Scan Summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Core Security Scans" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan (npm audit + Trivy) | ${{ needs.dependency-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Detection (Gitleaks + TruffleHog) | ${{ needs.secret-detection.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL SAST | ${{ needs.codeql-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Semgrep SAST | ${{ needs.semgrep-sast.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OSV Scanner | ${{ needs.osv-scanner.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Compliance & Supply Chain" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM Generation & Signing | ${{ needs.sbom-generation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Compliance | ${{ needs.license-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| IaC Security (Checkov) | ${{ needs.iac-security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| FIPS Compliance | ${{ needs.fips-compliance-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Provenance | ${{ needs.dependency-provenance.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed results in the Security tab and artifacts." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Gov/FedRAMP Compliance Notes" >> $GITHUB_STEP_SUMMARY
          echo "- SBOM: Generated in SPDX and CycloneDX formats, signed with Cosign" >> $GITHUB_STEP_SUMMARY
          echo "- SLSA: Build provenance generated for main branch builds" >> $GITHUB_STEP_SUMMARY
          echo "- Secrets: Scanned with Gitleaks and TruffleHog" >> $GITHUB_STEP_SUMMARY
          echo "- FIPS: Cryptographic library usage validated" >> $GITHUB_STEP_SUMMARY
